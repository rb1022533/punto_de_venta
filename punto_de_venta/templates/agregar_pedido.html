{% extends 'base.html' %}
{% load static %}

{% block content %}

<div>
  <button type="submit" form="pedido-form">Guardar Pedido</button>
  <a href="{% url 'lista_pedidos' %}">Cancelar</a>
</div>

<h2>{% if editar %}Editar Pedido{% else %}Registrar Pedido{% endif %}</h2>

<form method="POST" id="pedido-form">
  {% csrf_token %}

  <!-- Datos generales -->
  <div class="form-general">
    <div class="form-group">
      <label>Nombre Cliente:</label><br>
      {{ pedido_form.cliente_nombre }}
    </div>
    <div class="form-group">
      <label>Teléfono Cliente:</label><br>
      {{ pedido_form.cliente_telefono }}
    </div>
    <div class="form-group">
      <label>Dirección:</label><br>
      {{ pedido_form.direccion }}
    </div>
    <div class="form-group">
      <label>Fecha de Entrega:</label><br>
      {{ pedido_form.fecha_entrega }}
    </div>
    <div class="form-group">
      <label>Hora de Entrega:</label><br>
      {{ pedido_form.hora_entrega }}
    </div>
  </div>

  <!-- Sección para agregar productos -->
  <h3>Agregar productos</h3>
  <div>
    <select id="producto-input" style="width: 300px;">
      <option value="" disabled selected>Selecciona un producto</option>
      {% for producto in productos %}
        {% if producto.cantidad_stock > 0 %}
          <option value="{{ producto.id }}" data-precio="{{ producto.precio_venta }}" data-stock="{{ producto.cantidad_stock }}">
            {{ producto.nombre }}
          </option>
        {% endif %}
      {% endfor %}
    </select>

    <input type="number" id="cantidad-input" placeholder="Cantidad" min="1">
    <button type="button" id="add-producto">Agregar</button>
  </div>

  <!-- Lista de productos -->
  <h3>Lista de productos</h3>
  <table id="productos-table">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Subtotal</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% if detalles_existentes %}
        {% for detalle in detalles_existentes %}
        <tr data-producto-id="{{ detalle.producto_id }}">
          <td>{{ detalle.nombre }}</td>
          <td>{{ detalle.cantidad }}</td>
          <td>${{ detalle.precio_unitario }}</td>
          <td>${{ detalle.subtotal }}</td>
          <td><button type="button" class="eliminar-fila">Eliminar</button></td>
        </tr>
        {% endfor %}
      {% endif %}
    </tbody>
  </table>

  <div id="hidden-fields"></div>
</form>

{% if messages %}
<div id="django-messages" style="display:none;"
     data-messages='[
  {% for message in messages %}
    "{{ message|escapejs }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
]'></div>
{% endif %}

<style>
.form-general .form-group {
    margin-bottom: 15px;
}
.form-general label {
    font-weight: bold;
}
</style>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/agregar_pedido.js' %}"></script>
<script src="{% static 'js/mensajes.js' %}"></script>
{% endblock %}